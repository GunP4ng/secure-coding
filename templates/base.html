<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}My Market{% endblock %}</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Socket.IO í´ë¼ì´ì–¸íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js" integrity="sha384-mZLF4UVrpi/QTWPA7BjNPEnkIfRFn4ZEO3Qt/HFklHRpxOPIQeQlBV/MbxDqOkI+" crossorigin="anonymous"></script>
  <style>
    /* ì „ì²´ ìŠ¤íƒ€ì¼ */
    body {
      background-color: #F7F7F7;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 0;
      color: #333;
      line-height: 1.6;
    }
    
    /* ë„¤ë¹„ê²Œì´ì…˜ ë°” */
    nav {
      background-color: #fff;
      padding: 15px 20px;
      border-bottom: 1px solid #e0e0e0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .nav-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .nav-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    nav a {
      text-decoration: none;
      color: #555;
      font-weight: 500;
      padding: 8px 12px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }
    
    nav a:hover {
      background-color: #f0f0f0;
      transform: translateY(-1px);
    }
    
    nav a:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.5);
    }
    
    .admin-link {
      background-color: #FF3B30;
      color: white;
    }
    
    .admin-link:hover {
      background-color: #D70015;
    }
    
    .chat-link {
      background-color: #34C759;
      color: white;
    }
    
    .chat-link:hover {
      background-color: #2AA84A;
    }
    
    /* ì•Œë¦¼ ìŠ¤íƒ€ì¼ */
    .notification-container {
      position: relative;
    }
    
    .notification-icon {
      cursor: pointer;
      font-size: 20px;
      position: relative;
    }
    
    .notification-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background-color: #FF3B30;
      color: white;
      border-radius: 50%;
      padding: 2px 6px;
      font-size: 12px;
      font-weight: bold;
    }
    
    /* ì•Œë¦¼ ë“œë¡­ë‹¤ìš´ */
    .notification-dropdown {
      display: none;
      position: absolute;
      top: 40px;
      right: 0;
      background-color: white;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      width: 300px;
      max-height: 400px;
      overflow-y: auto;
      z-index: 1000;
      will-change: transform;
    }
    
    .notification-dropdown.show {
      display: block;
    }
    
    .notification-header {
      padding: 10px 15px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .notification-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .notification-item {
      padding: 12px 15px;
      border-bottom: 1px solid #f0f0f0;
      transition: background-color 0.2s ease;
    }
    
    .notification-item:hover {
      background-color: #f9f9f9;
    }
    
    .notification-item.unread {
      background-color: #f0f7ff;
    }
    
    /* ì•Œë¦¼ íƒ€ì…ë³„ ìŠ¤íƒ€ì¼ */
    .notification-type-payment_request {
      border-left: 4px solid #FFA500;
    }
    
    .notification-type-payment_response, 
    .notification-type-payment_complete {
      border-left: 4px solid #34C759;
    }
    
    .notification-type-chat_message {
      border-left: 4px solid #007AFF;
    }
    
    .notification-item a {
      text-decoration: none;
      color: #333;
      display: block;
      outline: none;
    }
    
    .notification-item a:focus {
      box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.5);
    }
    
    .notification-time {
      font-size: 12px;
      color: #999;
      margin-top: 5px;
    }
    
    .notification-empty {
      padding: 20px;
      text-align: center;
      color: #999;
    }
    
    /* ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    /* í”Œë˜ì‹œ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
    .flash {
      list-style: none;
      padding: 10px 15px;
      margin: 10px 0;
      border-radius: 4px;
      background-color: #f8f9fa;
      border: 1px solid #e0e0e0;
    }
    
    /* ë°˜ì‘í˜• ë””ìì¸ */
    @media (max-width: 768px) {
      nav {
        padding: 10px;
        flex-direction: column;
        align-items: flex-start;
      }
      
      .nav-left, .nav-right {
        width: 100%;
        margin-bottom: 10px;
      }
      
      nav a {
        padding: 6px 10px;
      }
      
      .notification-dropdown {
        width: 100%;
        right: 0;
      }
    }
  </style>
</head>
<body>
  <!-- CSRF í† í° hidden í•„ë“œ ì¶”ê°€ -->
  <input type="hidden" id="csrf_token" name="csrf_token" value="{{ csrf_token() }}">
  
  <nav>
    <div class="nav-left">
      {% if session.get('user_id') %}
        <a href="{{ url_for('dashboard') }}">ëŒ€ì‹œë³´ë“œ</a>
        <a href="{{ url_for('profile') }}">í”„ë¡œí•„</a>
        <a href="{{ url_for('chat_history') }}" class="chat-link">ì±„íŒ…ë°©</a>
        <a href="{{ url_for('report') }}">ì‹ ê³ í•˜ê¸°</a>
      {% else %}
        <a href="{{ url_for('login') }}">ë¡œê·¸ì¸</a>
        <a href="{{ url_for('register') }}">íšŒì›ê°€ì…</a>
      {% endif %}
    </div>
    <div class="nav-right">
      {% if session.get('user_id') %}
        <div class="notification-container">
          <div class="notification-icon" onclick="toggleNotifications()">
            ğŸ””
            {% if unread_notifications_count > 0 %}
              <span class="notification-badge">{{ unread_notifications_count }}</span>
            {% endif %}
          </div>
          <div class="notification-dropdown" id="notificationDropdown">
            <div class="notification-header">
              <h4>ì•Œë¦¼</h4>
              <form id="markAllReadForm" action="/notifications/mark-all-read" method="POST" style="display: inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <a href="#" onclick="document.getElementById('markAllReadForm').submit(); return false;">ëª¨ë‘ ì½ìŒ</a>
              </form>
            </div>
            <ul class="notification-list" id="notificationList">
              {% if notifications %}
                {% for notification in notifications %}
                  <li class="notification-item {% if not notification.is_read %}unread{% endif %}" data-id="{{ notification.id }}">
                    <a href="{{ notification.link }}" onclick="markAsRead('{{ notification.id }}'); return true;">
                      {{ notification.message }}
                      <div class="notification-time">{{ notification.created_at }}</div>
                    </a>
                  </li>
                {% endfor %}
              {% else %}
                <li class="notification-empty">ìƒˆë¡œìš´ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>
              {% endif %}
            </ul>
          </div>
        </div>
        {% if is_admin or session.get('is_admin') %}
          <a href="{{ url_for('admin_dashboard') }}" class="admin-link">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</a>
        {% endif %}
        <a href="{{ url_for('logout') }}">ë¡œê·¸ì•„ì›ƒ</a>
      {% endif %}
    </div>
  </nav>
  <div class="container">
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <ul>
          {% for message in messages %}
            <li class="flash">{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}
    {% block content %}{% endblock %}
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function toggleNotifications() {
      const dropdown = document.getElementById('notificationDropdown');
      const isOpen = dropdown.classList.contains('show');
      
      if (isOpen) {
        dropdown.classList.remove('show');
        document.removeEventListener('click', handleOutsideClick);
      } else {
        dropdown.classList.add('show');
        document.addEventListener('click', handleOutsideClick);
      }
    }
    
    function handleOutsideClick(event) {
      const dropdown = document.getElementById('notificationDropdown');
      const icon = document.querySelector('.notification-icon');
      
      if (!icon.contains(event.target) && !dropdown.contains(event.target)) {
        dropdown.classList.remove('show');
        document.removeEventListener('click', handleOutsideClick);
      }
    }
    
    // ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬ í•¨ìˆ˜
    function markAsRead(notificationId) {
      // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
      const csrfToken = document.getElementById('csrf_token').value;
      
      fetch(`/notifications/mark-read/${notificationId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-TOKEN': csrfToken
        }
      }).then(response => response.json())
        .then(data => {
          console.log('ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬ ì™„ë£Œ:', data);
        })
        .catch(error => {
          console.error('ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
        });
      
      // ì•Œë¦¼ í•­ëª©ì˜ ì½ìŒ ìƒíƒœ ì‹œê°ì  ì—…ë°ì´íŠ¸
      const notificationItem = document.querySelector(`.notification-item[data-id="${notificationId}"]`);
      if (notificationItem) {
        notificationItem.classList.remove('unread');
      }
      
      // ì½ì§€ ì•Šì€ ì•Œë¦¼ ê°œìˆ˜ ì—…ë°ì´íŠ¸
      updateUnreadCount();
    }
    
    function updateUnreadCount() {
      const unreadItems = document.querySelectorAll('.notification-item.unread');
      const badge = document.querySelector('.notification-badge');
      
      if (badge) {
        if (unreadItems.length > 0) {
          badge.textContent = unreadItems.length;
          badge.style.display = 'block';
        } else {
          badge.style.display = 'none';
        }
      }
    }
    
    // ì›¹ì†Œì¼“ ì—°ê²° ë° ì•Œë¦¼ ì²˜ë¦¬
    document.addEventListener('DOMContentLoaded', function() {
      {% if session.get('user_id') %}
        // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
        const csrfToken = '{{ csrf_token() }}';
      
        // Socket.IO í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
        const socket = io();
        
        // ì—°ê²° ìƒíƒœ ë¡œê¹…
        socket.on('connect', function() {
          console.log('Socket.IO ì—°ê²° ì„±ê³µ');
          
          // ì•Œë¦¼ ì†Œì¼“ ë£¸ ì°¸ì—¬
          socket.emit('join_notification_room', { 
            user_id: "{{ session.get('user_id') }}" 
          });
        });
        
        socket.on('connect_error', function(error) {
          console.error('Socket.IO ì—°ê²° ì˜¤ë¥˜:', error);
        });
        
        socket.on('disconnect', function() {
          console.log('Socket.IO ì—°ê²° í•´ì œ');
        });
        
        // ìƒˆ ë©”ì‹œì§€ ìˆ˜ì‹  ì²˜ë¦¬
        socket.on('message', function(data) {
          console.log('ë©”ì‹œì§€ ìˆ˜ì‹ :', data);
          // ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì•Œë¦¼ í‘œì‹œ
          if (data.sender_id !== "{{ session.get('user_id') }}") {
            // ìƒˆ ì•Œë¦¼ ì¶”ê°€
            addNotification({
              id: Date.now(), // ì„ì‹œ ID
              message: `${data.sender_name}ë‹˜ì´ ë©”ì‹œì§€ë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤: ${data.content.substr(0, 20)}${data.content.length > 20 ? '...' : ''}`,
              link: `/chat/${data.room_id}`,
              is_read: false,
              created_at: data.created_at || new Date().toISOString()
            });
          }
        });
        
        // ê°œì¸ ë©”ì‹œì§€ ì•Œë¦¼ ì²˜ë¦¬
        socket.on('message_notification', function(data) {
          console.log('ê°œì¸ ë©”ì‹œì§€ ì•Œë¦¼ ìˆ˜ì‹ :', data);
          // ìƒˆ ì•Œë¦¼ ì¶”ê°€
          addNotification({
            id: Date.now(), // ì„ì‹œ ID
            message: `${data.sender_name}ë‹˜ì´ ë©”ì‹œì§€ë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤: ${data.content.substr(0, 20)}${data.content.length > 20 ? '...' : ''}`,
            link: `/chat/${data.room_id}`,
            is_read: false,
            created_at: data.created_at || new Date().toISOString()
          });
        });
        
        // ì†¡ê¸ˆ ìš”ì²­ ì•Œë¦¼ ì²˜ë¦¬
        socket.on('payment_request', function(data) {
          console.log('ì†¡ê¸ˆ ìš”ì²­ ìˆ˜ì‹ :', data);
          addNotification({
            id: Date.now(), // ì„ì‹œ ID
            message: `${data.sender_name}ë‹˜ì´ ${data.amount.toLocaleString()}ì› ì†¡ê¸ˆì„ ìš”ì²­í–ˆìŠµë‹ˆë‹¤.`,
            link: `/chat/${data.sender_id}`,
            is_read: false,
            created_at: data.created_at || new Date().toISOString()
          });
        });
        
        // ì„œë²„ë¡œë¶€í„° ì§ì ‘ ì•Œë¦¼ ìˆ˜ì‹ 
        socket.on('notification', function(data) {
          console.log('ì•Œë¦¼ ìˆ˜ì‹ :', data);
          addNotification({
            id: data.id || Date.now(), 
            message: data.message,
            link: data.link,
            is_read: false,
            created_at: data.created_at || new Date().toISOString()
          });
        });
      {% endif %}
    });
    
    // ìƒˆ ì•Œë¦¼ ì¶”ê°€ í•¨ìˆ˜
    function addNotification(notification) {
      console.log('ì•Œë¦¼ ì¶”ê°€:', notification);
      const notificationList = document.getElementById('notificationList');
      if (!notificationList) {
        console.error('ì•Œë¦¼ ëª©ë¡ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      const emptyNotice = notificationList.querySelector('.notification-empty');
      if (emptyNotice) {
        notificationList.innerHTML = '';
      }
      
      const li = document.createElement('li');
      li.className = 'notification-item unread';
      
      // ì•Œë¦¼ íƒ€ì…ì— ë”°ë¼ í´ë˜ìŠ¤ ì¶”ê°€
      if (notification.notification_type) {
        li.classList.add(`notification-type-${notification.notification_type}`);
      }
      
      li.dataset.id = notification.id;
      li.dataset.type = notification.notification_type || 'message';
      
      const a = document.createElement('a');
      a.href = notification.link;
      a.onclick = function() {
        markAsRead(notification.id);
        return true;
      };
      
      // ì•Œë¦¼ íƒ€ì…ì— ë”°ë¼ ì•„ì´ì½˜ ì¶”ê°€
      let notifIcon = '';
      switch(notification.notification_type) {
        case 'payment_request':
          notifIcon = 'ğŸ’° ';
          break;
        case 'payment_response':
        case 'payment_complete':
          notifIcon = 'ğŸ’¸ ';
          break;
        case 'chat_message':
          notifIcon = 'ğŸ’¬ ';
          break;
        default:
          notifIcon = 'ğŸ”” ';
      }
      
      // ì•„ì´ì½˜ê³¼ ë©”ì‹œì§€ë¥¼ ê²°í•©
      a.innerHTML = notifIcon + notification.message;
      
      const timeDiv = document.createElement('div');
      timeDiv.className = 'notification-time';
      timeDiv.textContent = notification.created_at;
      
      a.appendChild(timeDiv);
      li.appendChild(a);
      
      // ëª©ë¡ ë§¨ ìœ„ì— ì¶”ê°€
      if (notificationList.firstChild) {
        notificationList.insertBefore(li, notificationList.firstChild);
      } else {
        notificationList.appendChild(li);
      }
      
      // ì•Œë¦¼ ê°œìˆ˜ ì—…ë°ì´íŠ¸
      updateUnreadCount();
      
      // ì•Œë¦¼ ì•„ì´ì½˜ ê¹œë¹¡ì´ê¸°
      const notificationIcon = document.querySelector('.notification-icon');
      if (notificationIcon) {
        notificationIcon.classList.add('blink');
        setTimeout(() => {
          notificationIcon.classList.remove('blink');
        }, 3000);
      }
      
      // ì•Œë¦¼ ì†Œë¦¬ ì¬ìƒ (ì„ íƒ ì‚¬í•­)
      try {
        const audio = new Audio('/static/notification.mp3');
        audio.volume = 0.5;
        audio.play().catch(e => console.log('ì•Œë¦¼ ì†Œë¦¬ ì¬ìƒ ë¶ˆê°€:', e));
      } catch (e) {
        console.log('ì•Œë¦¼ ì†Œë¦¬ ì§€ì›ë˜ì§€ ì•ŠìŒ:', e);
      }
    }
  </script>
  
  <style>
    /* ì•Œë¦¼ ì•„ì´ì½˜ ê¹œë¹¡ì„ ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes blink {
      0% { opacity: 1; }
      50% { opacity: 0.4; }
      100% { opacity: 1; }
    }
    
    .notification-icon.blink {
      animation: blink 0.5s linear 3;
    }
  </style>
</body>
</html>
